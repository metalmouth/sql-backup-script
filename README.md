# Скрипт bash для автоматизации резервного копирования базы данных PostgreSQL

![image](https://github.com/user-attachments/assets/efaa31ae-9d00-4488-9f65-5145cba95be5)

## Файл ```pg_backup.config```
Дефолтная директория: ```/etc/pg_backup/pg_backup.config```

**Переменные**:
- BACKUP_USER (пользователь, который может делать резервные копии, исключая других; необязательна, может быть пустой)
- USERNAME (пользователь, который подключается к PostgreSQL; необязательна, может быть пустой, значение по умолчанию – ```postgres```)
- HOSTNAME (имя хоста для подключения к PostgreSQL; необязательна, может быть пустой, значение по умолчанию – ```localhost```)
- BACKUP_DIR  (каталог для хранения резервных копий; **обязательна**)
- VERBOSE (включает подробный режим, т.е. выводит информацию журнала на консоль; принимает значения *YES* или *NO*)
- ENABLE_LOGGING (активирует протоколирование процесса работы скрипта; принимает значения *YES* или *NO*)
- LOGPATH (каталог для хранения файла лога; **обязательна**)
- DAYS_TO_KEEP (период времени (в днях), по истечении которого резервные копии удаляются автоматически; **обязательна**)

  
## Файл ```pg_backup```

Если имя базы данных валидно - происходит инициализация имени хоста и имени пользователя для подключения к БД, затем осуществляется проверка содержимого переменной BACKUP_USER


Далее определяется переменная `CURRENT_DIR`, которая уникальна для каждой базы данных, создаем каталог, если это необходимо (именно в этом каталоге окажется zip-файл, содержащий копию БД)

Создаём шаблоны для SQL- и zip-файлов, подставляя в их названия вывод команды (date +%d-%m-%Y_%H:%M:%S), которая выводит настоящее время в формате «ДД-ММ-ГГГГ-ЧЧ:ММ:СС». 

Используя от имени пользователя (`postgres` по умолчанию) утилиту `pg_dump`, записываем её вывод в SQL-файл (в случае ошибки удаляем созданный каталог), затем сжимаем файл в zip-архив (в случае ошибки выход с кодом ошибки 1, в случае успеха – удаление SQL-файла). 

После успешного создания резервной копии утилитой `find` происходит проверка всех резервных копий текущей базы данных на дату создания, если копия создана позже, чем указано в переменной конфигурации `DAYS_TO_KEEP`, она удаляется.

> [!IMPORTANT]
> Для обеспечения автоматического выполнения скрипта можно воспользоваться утилитой cron (sudo crontab -e). Строка `0 0 * * * <path_to_script>/pg_backup -d <databasename>` позволит утилите автоматически запускаться раз в день в 00:00 часов.



## Использование
**Ключи**:
- `-c <configpath> `   
- `-d <databasename>` 
- `-h|help`          

> [!IMPORTANT]
> Пример: `sudo ./pg_backup -c <configpath> -d <databasename>`


